#!/bin/bash
# .scripts/pre-commit v2.5
# æª¢æŸ¥ staged æª”æ¡ˆæ˜¯å¦ç¼ºå°‘ EOF newline æˆ– CRLF æ›è¡Œå•é¡Œï¼Œä¸¦é˜»æ­¢æäº¤

SCRIPT_VERSION="v2.5"
echo "ğŸ” Pre-commit ${SCRIPT_VERSION}: checking files..."

# å–å¾— staged çš„æ–‡å­—æª”
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -vE '(^|/)\.git/' | xargs file | grep -i 'text' | cut -d: -f1)

if [[ -z "$staged_files" ]]; then
    echo "âœ… æ²’æœ‰éœ€æª¢æŸ¥çš„æ–‡å­—æª”ï¼Œè·³éæª¢æŸ¥ã€‚"
    exit 0
fi

# åˆå§‹åŒ–
has_issue=0
newline_issues=()
crlf_issues=()

for file in $staged_files; do
    # ç¢ºä¿æª”æ¡ˆä»å­˜åœ¨
    [[ ! -f "$file" ]] && continue

    # æª¢æŸ¥ EOF newline
    last_char=$(tail -c1 "$file")
    if [[ "$last_char" != "" && "$last_char" != $'\n' ]]; then
        echo "âŒ $file is missing newline at end of file"
        has_issue=1
        newline_issues+=("$file")
    fi

    # æª¢æŸ¥ CRLF
    if grep -q $'\r' "$file"; then
        echo "âŒ $file contains Windows-style CRLF line endings"
        has_issue=1
        crlf_issues+=("$file")
    fi
done

# æœ‰å•é¡Œå‰‡ä¸­æ­¢æäº¤
if [[ $has_issue -ne 0 ]]; then
    echo "ğŸ›‘ Commit aborted due to formatting issues."

    echo "ğŸ”§ ä½ å¯ä»¥ä¿®æ­£é€™äº›å•é¡Œï¼š"
    echo "    .scripts/check_newline_eof.sh --fix-all <file|dir>"

    # é¡¯ç¤ºå…·é«”å»ºè­°è·¯å¾‘
    if [[ ${#newline_issues[@]} -gt 0 ]]; then
        echo "    ç¼ºå°‘æ›è¡Œçš„æª”æ¡ˆï¼š"
        for f in "${newline_issues[@]}"; do echo "      - $f"; done
    fi

    if [[ ${#crlf_issues[@]} -gt 0 ]]; then
        echo "    CRLF æª”æ¡ˆï¼š"
        for f in "${crlf_issues[@]}"; do echo "      - $f"; done
    fi

    exit 1
else
    # åˆ—å‡ºé‡è¤‡å‡ºç¾åœ¨staged & unstagedçš„è®Šæ›´
    am_count=$(git status --porcelain | grep AM | wc -l)
    if (( am_count > 0 )); then
        am_change=$(git status --porcelain | grep AM)
        echo "âš ï¸  æª”æ¡ˆå·²ä¿®æ­£ä½†å°šæœªé‡æ–°åŠ å…¥ staging å€ï¼š"
        echo "ğŸ‘‰ è«‹åŸ·è¡Œ 'git add <file>' å¾Œå†é‡æ–° commitã€‚"
	echo "$am_change" | while IFS= read -r file; do
            echo "      - $file"
	done

	exit 1
    else
        echo "âœ… All checks passed. Proceeding with commit."
	exit 0
    fi
fi

