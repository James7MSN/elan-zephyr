# SHA-256 Driver Debug Report — 400KB EC-Style Updates (WORKING)

Date/Time: 2025-10-27 21:05
Board: 32f967_dv (EM32F967)
Zephyr: v4.2.0-3464-g3476212f72f7
Sample: samples/elan_sha (main_large_data_ec_sim.c)
Data size: 409,600 bytes (400KB)
Chunk size: 65,536 bytes (64KB)
Chunks: 7 (6×64KB + 1×16KB)
Expected SHA-256: 870130e6ddddd5d74acfa65ae6e060c0bdc135930cc55562c696737c6d046aee

---

## 1) Executive Summary

- The SHA-256 driver and test application successfully process 400KB of data in EC-style chunked updates.
- All tests passed (3/3). The hardware hash matches the expected 400KB reference digest.
- Root cause of earlier failures: re-writing the CTR register on non‑first chunks cleared the STR bit, leaving the engine idle (STA=0). Fix was to avoid writing CTR after the first chunk; only stream data and program PAD_CTR at finalization.

## 2) Context and Goal

- Goal: Support EC-style chunked hashing of large data without timeouts or digest mismatches.
- Requirements provided by user:
  1) Set DATALEN to total message length on the first chunk only.
  2) Do not update conditions (no CTR/DATALEN writes) on subsequent chunks.
  3) Only at finalization, write PAD_CTR and trigger the final run.

## 3) Implementation Details

Driver: drivers/crypto/crypto_em32_sha.c
- First chunk:
  - Reset + configure
  - Program DATALEN = TOTAL length (words)
  - Assert STR once before first data words
- Subsequent chunks:
  - Do NOT write CTR
  - Stream input words only; poll READY appropriately
- Finalization:
  - Compute pad_packet with bmod derived from total bits
  - Write PAD_CTR once
  - Write one dummy word to trigger completion; wait for STA

Test app: samples/elan_sha/src/main_large_data_ec_sim.c
- TEST_DATA_SIZE = 400KB (409,600 bytes), CHUNK_SIZE = 64KB
- Calls driver helper to set total message size before updates
- Three tests run: chunked single-session, EC-style with delays, and verification loop

## 4) Key Evidence from Console Log (Working)

Highlights showing correct behavior:
- DATALEN programmed once to 102,400 words (3276800 bits) on the first chunk
- CTR during updates remains 0x00000309 (READY=1, STR=1, STA=0 while ingesting)
- On the final (short) chunk, STA becomes 1 before finalization: CTR=0x00000318
- Finalization writes PAD_CTR with bmod=0, pad_packet=14 and completes immediately (STA set after 0 iterations)
- Reported hash matches expected 400KB digest

Expected SHA-256 (400KB deterministic pattern):
870130e6ddddd5d74acfa65ae6e060c0bdc135930cc55562c696737c6d046aee

## 5) Root Cause and Fix (Recap)

- Root cause (previous behavior): The driver wrote CTR on every chunk, which cleared STR after the first chunk. With STR cleared, the engine stayed idle and never advanced, causing timeouts or digest of only the first block.
- Fix (current behavior): Only write CTR on the first chunk (with STR). For subsequent chunks, do not touch CTR; only stream data words. At finalization, write PAD_CTR and a dummy word to complete.

## 6) Results

- Test 1 (Chunked 400KB Hash): PASSED
- Test 2 (EC-style chunked transfer): PASSED
- Test 3 (Chunked processing verification): PASSED
- Digest observed in all cases:
  870130e6ddddd5d74acfa65ae6e060c0bdc135930cc55562c696737c6d046aee

## 7) Build Details

- Built target: 32f967_dv
- Artifacts: build/zephyr/zephyr.elf (and .hex/.bin)
- Memory usage (example from successful build):
  - FLASH: ~46 KB (≈8.39%)
  - RAM: ~127 KB (≈77.7%)

## 8) Full Console Log (Working Run)

```
[00:00:00.000,000] <dbg> em32_ahb: elan_em32_ahb_clock_control_init: clock_source=0x1, clock_frequency=0x13, clock_divider=0x0. 
[00:00:00.000,000] <dbg> em32_ahb: elan_em32_set_ahb_freq: ahb_count=96000. 
[00:00:00.000,000] <dbg> em32_apb: elan_em32_apb_clock_control_init: Initialized. 
[00:00:00.000,000] <inf> pinctrl_em32: Configuring 2 pins 
[00:00:00.000,000] <inf> pinctrl_em32: Successfully configured 2 pins 
[00:00:00.000,000] <inf> gpio_em32: Initializing EM32 GPIO port 0 at 0x40020000 
[00:00:00.000,000] <inf> gpio_em32: EM32 GPIO port 0 initialized successfully 
[00:00:00.000,000] <inf> gpio_em32: Initializing EM32 GPIO port 1 at 0x40021000 
[00:00:00.000,000] <inf> gpio_em32: EM32 GPIO port 1 initialized successfully 
[00:00:00.000,000] <inf> pinctrl_em32: EM32F967 pinctrl driver initializing 
[00:00:00.000,000] <inf> pinctrl_em32: EM32F967 pinctrl driver initialized (IOShare: 0x00000040) 
[00:00:00.000,000] <inf> udc_e967: Device 0x100091e8 (max. speed 1) 
[00:00:00.000,000] <inf> pinctrl_em32: Configuring 3 pins 
[00:00:00.000,000] <inf> pinctrl_em32: Successfully configured 3 pins 
*** Booting Zephyr OS build v4.2.0-3464-g3476212f72f7 *** 
[00:00:00.010,000] <inf> sha_large_data_test: ======================================== 
[00:00:00.010,000] <inf> sha_large_data_test: Large Data EC Communication Simulation 
[00:00:00.010,000] <inf> sha_large_data_test: Test Data Size: 409600 bytes (400KB) 
[00:00:00.010,000] <inf> sha_large_data_test: Chunk Size: 65536 bytes (64KB) 
[00:00:00.010,000] <inf> sha_large_data_test: Number of Chunks: 7 
[00:00:00.010,000] <inf> sha_large_data_test: ======================================== 
[00:00:00.010,000] <inf> sha_large_data_test: === Test 1: Chunked 400KB Hash (EC Communication Pattern) === 
[00:00:00.010,000] <inf> sha_large_data_test: Processing 409600 bytes in 65536-byte chunks 
[00:00:00.017,000] <inf> crypto_em32_sha: Switching to chunked processing for large input (input=65536 bytes >= 65536 bytes) 
[00:00:00.017,000] <dbg> crypto_em32_sha: process_sha256_hardware: First chunk: DATALEN set to 102400 words (3276800 bits) 
[00:00:00.017,000] <dbg> crypto_em32_sha: process_sha256_hardware: First chunk: SHA_STR set, starting operation 
[00:00:00.038,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.038,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.038,000] <dbg> crypto_em32_sha: process_sha256_hardware: First chunk processed, waiting for more chunks 
[00:00:00.046,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.066,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.066,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.066,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.074,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.095,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.095,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.095,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.102,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.123,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.123,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.123,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.130,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.151,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.151,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.151,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.158,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.179,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.179,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.179,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.181,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.186,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.186,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.186,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.186,000] <dbg> crypto_em32_sha: em32_sha256_handler: Finalization: total_bits=3276800, bmod=0, pad_packet=14, pad_ctrl=0x0000000e 
[00:00:00.186,000] <dbg> crypto_em32_sha: em32_sha256_handler: Before PAD_CTR write: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.186,000] <dbg> crypto_em32_sha: em32_sha256_handler: PAD_CTR written 
[00:00:00.186,000] <dbg> crypto_em32_sha: em32_sha256_handler: Dummy word written 
[00:00:00.186,000] <dbg> crypto_em32_sha: em32_sha256_handler: STA_BIT set after 0 iterations 
[00:00:00.186,000] <inf> sha_large_data_test: Chunked 400KB hash completed successfully 
[00:00:00.187,000] <inf> sha_large_data_test: Hash: 870130e6ddddd5d74acfa65ae6e060c0bdc135930cc55562c696737c6d046aee 
[00:00:00.187,000] <inf> sha_large_data_test: … VERIFICATION PASSED - Hash matches expected pattern! 
[00:00:00.187,000] <inf> sha_large_data_test: Test 1 PASSED 
[00:00:00.687,000] <inf> sha_large_data_test: === Test 2: EC-style Chunked Transfer (64KB chunks) === 
[00:00:00.687,000] <inf> sha_large_data_test: Total data: 409600 bytes, Chunk size: 65536 bytes, Num chunks: 7 
[00:00:00.687,000] <inf> sha_large_data_test: Session started (EC init phase) 
[00:00:00.687,000] <inf> sha_large_data_test: Processing chunk 1: offset=0, size=65536 
[00:00:00.693,000] <inf> crypto_em32_sha: Switching to chunked processing for large input (input=65536 bytes >= 65536 bytes) 
[00:00:00.693,000] <dbg> crypto_em32_sha: process_sha256_hardware: First chunk: DATALEN set to 102400 words (3276800 bits) 
[00:00:00.693,000] <dbg> crypto_em32_sha: process_sha256_hardware: First chunk: SHA_STR set, starting operation 
[00:00:00.714,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.714,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.714,000] <dbg> crypto_em32_sha: process_sha256_hardware: First chunk processed, waiting for more chunks 
[00:00:00.724,000] <inf> sha_large_data_test: Processing chunk 2: offset=65536, size=65536 
[00:00:00.730,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.751,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.751,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.751,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.761,000] <inf> sha_large_data_test: Processing chunk 3: offset=131072, size=65536 
[00:00:00.767,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.788,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.788,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.788,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.798,000] <inf> sha_large_data_test: Processing chunk 4: offset=196608, size=65536 
[00:00:00.804,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.825,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.825,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.825,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.835,000] <inf> sha_large_data_test: Processing chunk 5: offset=262144, size=65536 
[00:00:00.841,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.861,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.861,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.861,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.872,000] <inf> sha_large_data_test: Processing chunk 6: offset=327680, size=65536 
[00:00:00.878,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.898,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.898,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:00.898,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.908,000] <inf> sha_large_data_test: Processing chunk 7: offset=393216, size=16384 
[00:00:00.910,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:00.915,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000318 (READY=1, STA=1) 
[00:00:00.915,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000318 (READY=1, STA=1) 
[00:00:00.915,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:00.925,000] <inf> sha_large_data_test: All 7 chunks sent, finalizing hash (EC final phase)... 
[00:00:00.925,000] <dbg> crypto_em32_sha: em32_sha256_handler: Finalization: total_bits=3276800, bmod=0, pad_packet=14, pad_ctrl=0x0000000e 
[00:00:00.925,000] <dbg> crypto_em32_sha: em32_sha256_handler: Before PAD_CTR write: CTR=0x00000318 (READY=1, STA=1) 
[00:00:00.925,000] <dbg> crypto_em32_sha: em32_sha256_handler: PAD_CTR written 
[00:00:00.925,000] <dbg> crypto_em32_sha: em32_sha256_handler: Dummy word written 
[00:00:00.925,000] <dbg> crypto_em32_sha: em32_sha256_handler: STA_BIT set after 0 iterations 
[00:00:00.925,000] <inf> sha_large_data_test: EC-style chunked transfer completed successfully 
[00:00:00.926,000] <inf> sha_large_data_test: Hash: 870130e6ddddd5d74acfa65ae6e060c0bdc135930cc55562c696737c6d046aee 
[00:00:00.926,000] <inf> sha_large_data_test: … VERIFICATION PASSED - Hash matches expected pattern! 
[00:00:00.926,000] <inf> sha_large_data_test: Test 2 PASSED 
[00:00:01.426,000] <inf> sha_large_data_test: === Test 3: Chunked Processing Verification === 
[00:00:01.426,000] <inf> sha_large_data_test: Verifying chunked processing with 409600 bytes in 65536-byte chunks 
[00:00:01.433,000] <inf> crypto_em32_sha: Switching to chunked processing for large input (input=65536 bytes >= 65536 bytes) 
[00:00:01.433,000] <dbg> crypto_em32_sha: process_sha256_hardware: First chunk: DATALEN set to 102400 words (3276800 bits) 
[00:00:01.433,000] <dbg> crypto_em32_sha: process_sha256_hardware: First chunk: SHA_STR set, starting operation 
[00:00:01.454,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.454,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.454,000] <dbg> crypto_em32_sha: process_sha256_hardware: First chunk processed, waiting for more chunks 
[00:00:01.462,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:01.482,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.482,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.482,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:01.490,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:01.511,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.511,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.511,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:01.518,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:01.539,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.539,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.539,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:01.546,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:01.567,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.567,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.567,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:01.574,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:01.595,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.595,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000309 (READY=1, STA=0) 
[00:00:01.595,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:01.597,000] <dbg> crypto_em32_sha: process_sha256_hardware: Writing data for subsequent chunk (no CTR write) 
[00:00:01.602,000] <dbg> crypto_em32_sha: process_sha256_hardware: Before READY wait: CTR=0x00000318 (READY=1, STA=1) 
[00:00:01.602,000] <dbg> crypto_em32_sha: process_sha256_hardware: After READY wait: CTR=0x00000318 (READY=1, STA=1) 
[00:00:01.602,000] <dbg> crypto_em32_sha: process_sha256_hardware: Chunk processed, returning 
[00:00:01.602,000] <dbg> crypto_em32_sha: em32_sha256_handler: Finalization: total_bits=3276800, bmod=0, pad_packet=14, pad_ctrl=0x0000000e 
[00:00:01.602,000] <dbg> crypto_em32_sha: em32_sha256_handler: Before PAD_CTR write: CTR=0x00000318 (READY=1, STA=1) 
[00:00:01.602,000] <dbg> crypto_em32_sha: em32_sha256_handler: PAD_CTR written 
[00:00:01.602,000] <dbg> crypto_em32_sha: em32_sha256_handler: Dummy word written 
[00:00:01.602,000] <dbg> crypto_em32_sha: em32_sha256_handler: STA_BIT set after 0 iterations 
[00:00:01.602,000] <inf> sha_large_data_test: … Chunked processing verification PASSED - processed 7 chunks successfully 
[00:00:01.603,000] <inf> sha_large_data_test: Hash: 870130e6ddddd5d74acfa65ae6e060c0bdc135930cc55562c696737c6d046aee 
[00:00:01.603,000] <inf> sha_large_data_test: … VERIFICATION PASSED - Hash matches expected pattern! 
[00:00:01.603,000] <inf> sha_large_data_test: Test 3 PASSED 
[00:00:01.603,000] <inf> sha_large_data_test: ======================================== 
[00:00:01.603,000] <inf> sha_large_data_test: Test Summary: 3 passed, 0 failed 
[00:00:01.603,000] <inf> sha_large_data_test: ======================================== 
```

## 9) Recommendations

- Keep the "no CTR write on subsequent chunks" policy; only assert STR once on the first chunk.
- Maintain PAD_CTR-only finalization. The bmod/pad_packet calculation observed (bmod=0 → pad_packet=14) is correct for 400KB.
- Optional: reduce debug verbosity in production builds and enable only on-demand.

## 10) Next Steps

- If desired, add a unit/integration test to assert that for any N×64KB + tail input, the driver does not write CTR after the first chunk and that final hashes match a software SHA-256 reference.
- Extend to SHA-1/SHA-224 if supported, following the same streaming discipline.

